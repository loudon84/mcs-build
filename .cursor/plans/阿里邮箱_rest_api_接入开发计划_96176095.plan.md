---
name: 阿里邮箱 REST API 接入开发计划
overview: 实现阿里邮箱 REST API 接入，包括 OAuth 2.0 认证、邮件监听、附件下载等功能，集成到现有的 mcs-listener 统一监听服务架构中。
todos: []
isProject: false
status: completed
---

# 阿里邮箱 REST API 接入开发计划

## 架构设计

采用分层架构，遵循现有 `mcs_listener` 的设计模式：

```
clients/              → API 客户端层（封装 REST API 调用）
listeners/            → 监听器层（实现 BaseListener 接口）
processors/           → 处理器层（复用 EmailProcessor）
scheduler.py          → 调度器（注册新监听器）
settings.py           → 配置（添加阿里邮箱配置项）
```

## 实现步骤

### 阶段一：基础架构搭建

#### 1. 创建 clients 目录结构

- 创建 `src/mcs_listener/clients/` 目录
- 创建 `__init__.py` 文件
- 创建 `exceptions.py` 定义异常类

#### 2. 实现 OAuth Token 管理器

**文件**：`src/mcs_listener/clients/alimail_client.py`

实现 `OAuthManager` 类：

- `get_token()`: 获取有效 token（带缓存和自动刷新）
- `refresh_token()`: 刷新 token
- `is_token_valid()`: 检查 token 有效性
- Token 缓存机制（内存缓存，包含 expires_at）
- 自动刷新逻辑（提前 5 分钟刷新）

**关键实现点**：

- 使用 `httpx` 进行 HTTP 请求（项目已有依赖）
- Token 缓存使用类变量或实例变量
- 处理 token 过期异常

#### 3. 实现阿里邮箱 API 客户端

**文件**：`src/mcs_listener/clients/alimail_client.py`

实现 `AlimailClient` 类，封装所有 REST API 调用：

**方法列表**：

- `get_access_token()`: 获取访问凭证（委托给 OAuthManager）
- `list_mail_folders()`: 获取邮箱文件夹列表
- `list_messages(folder_id, cursor="", size=100, orderby="DES")`: 获取邮件列表（支持分页）
- `get_message(message_id)`: 获取邮件详情
- `list_attachments(message_id)`: 获取附件列表
- `download_attachment(message_id, attachment_id)`: 下载附件（流式下载）

**关键实现点**：

- 所有请求自动添加 `Authorization: bearer {token}` 头
- 统一错误处理（401 自动刷新 token 重试）
- 使用 `httpx.AsyncClient` 进行异步请求
- 附件下载使用 `stream=True` 支持大文件
- 实现重试机制（网络错误、5xx 错误）

### 阶段二：监听器实现

#### 4. 创建 AlimailListener

**文件**：`src/mcs_listener/listeners/alimail_listener.py`

实现 `AlimailListener` 类，继承 `BaseListener`：

**实现方法**：

- `connect()`: 初始化 OAuth，获取 token（通过 AlimailClient）
- `disconnect()`: 清理资源（REST API 无需保持连接）
- `poll_new_messages(folder_id=None)`: 轮询新邮件
  - 使用 cursor 分页机制
  - 返回 message_id 列表
  - 处理 `hasMore` 和 `nextCursor`
- `fetch_message(message_id)`: 获取邮件内容
  - 调用 `get_message()` API
  - 如果有附件，调用 `list_attachments()` + `download_attachment()`
  - 转换为统一格式（与 IMAP 格式一致）
- `mark_as_processed(message_id)`: 标记为已处理
  - 阿里邮箱 API 可能没有直接标记已读接口
  - 通过数据库记录实现（已在 scheduler 中处理）

**数据格式转换**：

- 将阿里邮箱 API 返回的 JSON 格式转换为与 `EmailListener.fetch_message()` 相同的格式
- 字段映射：
  - `id` → `uid` 和 `message_id`
  - `from.email` → `from`
  - `toRecipients` → `to`（字符串，逗号分隔）
  - `ccRecipients` → `cc`（字符串，逗号分隔）
  - `body.bodyText` → `body`
  - `body.bodyHtml` → 可选，暂不处理
  - `sentDateTime` / `receivedDateTime` → 时间处理
  - 附件：从 `ListAttachments` + `Download` 获取

**关键实现点**：

- `channel_type` 返回 `"email"`（与 EmailListener 相同，便于统一处理）
- 处理时区问题（阿里邮箱返回时间与北京时间相差 8 小时）
- 附件下载使用流式方式，避免内存溢出
- 错误处理和重试逻辑

### 阶段三：配置与集成

#### 5. 扩展 Settings 配置

**文件**：`src/mcs_listener/settings.py`

添加阿里邮箱配置项：

```python
# 阿里邮箱配置
alimail_client_id: str = ""
alimail_client_secret: str = ""
alimail_email_account: str = ""  # 用户邮箱地址
alimail_api_base_url: str = "https://alimail-cn.aliyuncs.com"
alimail_folder_id: str = "2"  # 默认收件箱
alimail_poll_size: int = 100  # 每次轮询的邮件数量
```

#### 6. 修改 Scheduler 集成

**文件**：`src/mcs_listener/scheduler.py`

在 `start()` 方法中修改邮件监听器初始化逻辑：

```python
if "email" in enabled:
    if self.settings.email_provider == "alimail":
        from mcs_listener.listeners.alimail_listener import AlimailListener
        email_listener = AlimailListener(
            client_id=self.settings.alimail_client_id,
            client_secret=self.settings.alimail_client_secret,
            email_account=self.settings.alimail_email_account,
            folder_id=self.settings.alimail_folder_id,
        )
    else:
        # 现有的 IMAP 实现
        email_listener = EmailListener(...)
    
    self.listeners["email"] = email_listener
    self.processors["email"] = EmailProcessor()
```

**关键点**：

- 通过 `email_provider` 配置选择使用哪个实现
- 复用现有的 `EmailProcessor`（数据格式已统一）
- 复用现有的 `_poll_email()` 方法（无需修改）

#### 7. 扩展 EmailProcessor（可选）

**文件**：`src/mcs_listener/processors/email.py`

如果需要处理阿里邮箱特有的数据格式：

- 检查 `provider == "alimail"` 时的特殊处理
- 处理 `cc` 字段（当前为空列表，阿里邮箱有数据）
- 处理 `body_html` 字段（如果阿里邮箱提供）

### 阶段四：测试与文档

#### 8. 单元测试

创建测试文件：

- `tests/test_clients/test_alimail_client.py`: 测试 API 客户端
- `tests/test_listeners/test_alimail_listener.py`: 测试监听器

**测试覆盖**：

- OAuth token 获取和刷新
- API 调用（使用 mock）
- 数据格式转换
- 错误处理

#### 9. 集成测试

- 端到端测试（需要真实的阿里邮箱账号和凭证）
- 测试轮询流程
- 测试附件下载

#### 10. 文档更新

- 更新 `README.md`，添加阿里邮箱配置说明
- 更新环境变量文档
- 添加使用示例

## 关键技术点

### 1. OAuth Token 管理

- Token 有效期通常为 3600 秒
- 实现内存缓存，避免频繁请求
- 提前 5 分钟刷新，避免过期
- 处理并发请求时的 token 刷新（加锁或使用 asyncio.Lock）

### 2. 分页处理

- 使用 cursor 机制进行分页
- 循环调用直到 `hasMore` 为 `false`
- 处理大量邮件时的性能优化

### 3. 附件下载

- 使用流式下载（`stream=True`）
- 支持大文件（避免内存溢出）
- 处理下载失败和重试

### 4. 数据格式统一

- 将阿里邮箱 API 返回格式转换为与 IMAP 一致的格式
- 确保 `EmailProcessor` 可以正确处理
- 处理时区转换

### 5. 错误处理

- 网络错误重试（3 次，指数退避）
- Token 过期自动刷新重试
- API 错误（4xx, 5xx）的适当处理
- 记录错误日志

## 文件清单

### 新增文件

1. `src/mcs_listener/clients/__init__.py`
2. `src/mcs_listener/clients/alimail_client.py` - API 客户端和 OAuth 管理器
3. `src/mcs_listener/listeners/alimail_listener.py` - 阿里邮箱监听器

### 修改文件

1. `src/mcs_listener/settings.py` - 添加阿里邮箱配置
2. `src/mcs_listener/scheduler.py` - 注册 AlimailListener
3. `src/mcs_listener/processors/email.py` - 可选：扩展支持阿里邮箱格式

### 测试文件

1. `tests/test_clients/test_alimail_client.py`
2. `tests/test_listeners/test_alimail_listener.py`

## 依赖检查

项目已有依赖：

- `httpx>=0.25.0` ✅（用于 HTTP 请求）
- `pydantic>=2.0.0` ✅（用于数据验证）
- `mcs-contracts` ✅（EmailEvent 模型）

**无需新增依赖**

## 配置示例

环境变量配置：

```bash
ENABLED_LISTENERS=email
EMAIL_PROVIDER=alimail
ALIMAIL_CLIENT_ID=your_client_id
ALIMAIL_CLIENT_SECRET=your_client_secret
ALIMAIL_EMAIL_ACCOUNT=sales@example.com
ALIMAIL_FOLDER_ID=2
ALIMAIL_POLL_SIZE=100
```

## 注意事项

1. **Token 安全**：`client_secret` 属于敏感信息，必须通过环境变量配置，不能硬编码
2. **时区处理**：阿里邮箱返回的时间与北京时间相差 8 小时，需要转换
3. **附件大小**：