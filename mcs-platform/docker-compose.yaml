version: '3.8'

services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: mcs
      POSTGRES_PASSWORD: password
      POSTGRES_DB: mcs_platform
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  orchestrator:
    build:
      context: .
      dockerfile: orchestrator/docker/Dockerfile
    environment:
      # 分库配置
      ORCHESTRATION_DB_DSN: postgresql://mcs:password@postgres:5432/mcs_orchestrator
      MASTERDATA_DB_DSN: postgresql://mcs:password@postgres:5432/mcs_masterdata
      LISTENER_DB_DSN: postgresql://mcs:password@postgres:5432/mcs_listener
      # Dify 配置
      DIFY_BASE_URL: ${DIFY_BASE_URL}
      DIFY_CONTRACT_APP_KEY: ${DIFY_CONTRACT_APP_KEY}
      DIFY_ORDER_APP_KEY: ${DIFY_ORDER_APP_KEY}
      # ERP Gateway 配置
      ERP_BASE_URL: ${ERP_BASE_URL:-http://erp:9000}
      ERP_API_KEY: ${ERP_API_KEY}
      ERP_TENANT_ID: ${ERP_TENANT_ID}
      # Listener 配置
      ENABLED_LISTENERS: ${ENABLED_LISTENERS:-email}
      EMAIL_PROVIDER: ${EMAIL_PROVIDER:-imap}
      IMAP_HOST: ${IMAP_HOST}
      IMAP_USER: ${IMAP_USER}
      IMAP_PASS: ${IMAP_PASS}
      ALIMAIL_CLIENT_ID: ${ALIMAIL_CLIENT_ID}
      ALIMAIL_CLIENT_SECRET: ${ALIMAIL_CLIENT_SECRET}
      ALIMAIL_EMAIL_ACCOUNT: ${ALIMAIL_EMAIL_ACCOUNT}
      # Cache 配置
      REDIS_URL: redis://redis:6379/0
    ports:
      - "18000:18000"
    depends_on:
      - postgres
      - redis

volumes:
  postgres_data:

